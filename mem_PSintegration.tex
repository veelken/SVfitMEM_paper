\subsection{Computation of phase space integral}
\label{sec:mem_PSintegration}

The integration over the differential $n$-particle phase space element
$d\bm{p}$ in Eq.~(\ref{eq:mem_with_hadRecoil}) is to be done differently
for $\Pgt\Pgt \to \tauhnu \, \tauhnu$, $\Pgt\Pgt \to \tauhnu \, \ellnunu$, 
and $\Pgt\Pgt \to \ellnunu \, \ellnunu$ decays ($\Plepton = \Pe, \Pgm$).
With the approximation that we treat hadronic $\Pgt$ decays as
two-body decays, the integral
over $d\bm{p}$ is of dimension $12$ in case of $\Pgt\Pgt \to \tauhnu \, \tauhnu$ decays,
of dimension $15$ in case of $\Pgt\Pgt \to \tauhnu \, \ellnunu$ decays,
and of dimension $18$ in case of $\Pgt\Pgt \to \ellnunu \, \ellnunu$ decays.
The differential phase space element reads:
\begin{equation}
d\bm{p} = 
 \begin{cases} 
   d\Phi^{(1)}_{\tauhnu} \, d\Phi^{(2)}_{\tauhnu} \, 
 & \mbox{if } \Pgt\Pgt \to \tauhnu1 \, \tauhnu2 \, , \\
   d\Phi^{(1)}_{\ellnunu} \, d\Phi^{(2)}_{\tauhnu} \, 
 & \mbox{if } \Pgt\Pgt \to \tauhnu1 \, \ellnunu2 \, , \\
   d\Phi^{(1)}_{\ellnunu} \, d\Phi^{(2)}_{\ellnunu} \, 
 & \mbox{if } \Pgt\Pgt \to \ellnunu1 \, \ellnunu2 \, ,
 \end{cases}
\label{eq:PSintegration_taupair}
\end{equation}
where
\begin{equation}
d\Phi^{(i)}_{\tauhnu} = d^{3}\bm{p}^{\vis(i)} \, d^{3}\bm{p}^{\Pnu(i)} 
\quad \mbox{ and } \quad 
d\Phi^{(i)}_{\ellnunu} = d^{3}\bm{p}^{\vis(i)} \, d^{3}\bm{p}^{\Pnu(i)} \, d^{3}\bm{p}^{\APnu(i)} \, .
\label{eq:PSintegration_onetau}
\end{equation}

The integrand in Eq.~(\ref{eq:mem_with_hadRecoil}) depends on the
four-momentum of the two $\Pgt$ leptons via the squared modulus of the
ME, $\vert \mathcal{M}_{\Pg\Pg \to \PHiggs \to \Pgt\Pgt}(\bm{p},m_{\PHiggs}) \vert^{2}$,
and on the four-momentum of the visible $\Pgt$ decay products via the
transfer functions $W( \bm{p}^{\vis(1)} | \phat^{\vis(1)} )$ and $W( \bm{p}^{\vis(2)} | \phat^{\vis(2)} )$.
In case of hadronic $\Pgt$ decays, 
we parametrize the $\Pgt$ lepton four-momentum as function of the momentum of the visible $\Pgt$ decay products and of two kinematic variables,
$z$ and $\phi_{\inv}$.
Leptonic $\Pgt$ decays are parametrized by three kinematic variables, $z$, $\phi_{\inv}$ and $m_{\inv}$.
The variable $z$ represents the fraction of $\Pgt$ lepton energy
carried by the visible $\Pgt$ decay products (\cf Eq.~(\ref{eq:def_z})).
We denote the four-momentum of, respectively, the $\Pgt$ neutrino
produced in hadronic $\Pgt$ decays and of the
four-momentum of the di-neutrino system produced in leptonic $\Pgt$
decays by the symbol $\bm{p}^{\inv}$.
The energy component $E_{\inv}$ is related to the variable $z$ via:
\begin{equation}
E_{\inv} = E_{\Pgt} - E_{\vis} = \frac{1 - z}{z} \, E_{\vis} \, .
\label{eq:E_inv}
\end{equation}
The mass of the four-vector is zero for hadronic $\Pgt$ decays and
equal to the variable $m_{\inv}$ in case of leptonic $\Pgt$ decays.
The energy fraction $z$ is furthermore related to the angle $\theta_{\inv}$ between the $\bm{p}^{\inv}$ vector and the direction of the visible $\Pgt$ decay products:
\begin{equation}
\cos\theta_{\inv} = \frac{E_{\vis} \, E_{\inv} - \frac{1}{2}(m^{2}_{\Pgt} - (m^{2}_{\vis} + m^{2}_{\inv}))}{\vert\bm{p^{\vis}}\vert \, \vert\bm{p^{\inv}}\vert} \, ,
\label{eq:theta_inv}
\end{equation}
as derrived in Sections~\ref{sec:appendix_tauToHadDecays}
and~\ref{sec:appendix_tauToLepDecays} of the appendix for,
respectively, hadronic and leptonic $\Pgt$ decays.
The variable $\phi_{\inv}$ specifies the orientation of the
$\bm{p}^{\inv}$ vector relative to the $\bm{p}^{\vis}$ vector.
As illustrated in Fig.~\ref{fig:tauDecayParametrization}, the
$\bm{p}^{\inv}$ vector lies on the surface of a cone that is centred
on the $\bm{p}^{\vis}$ vector and has opening angle $\theta_{\inv}$.
The variable $\phi_{\inv}$ represents the azimuthal angle around the
axis of the cone.
The value $\phi_{\inv} = 0$ corresponds to the case that the $\bm{p}^{\inv}$ vector is within the plane spanned by the $\bm{p}^{\vis}$ vector and the beam direction.
In case of hadronic (leptonic) $\Pgt$ decays, the vector $\bm{p}^{\inv}$ is fully
determined by $\bm{p}^{\vis}$, $z$ and $\phi_{\inv}$ ($\bm{p}^{\vis}$
, $z$, $\phi_{\inv}$, and $m_{\inv}$).
The $\Pgt$ lepton four-momentum $\bm{p}^{\Pgt}$ is given by the sum of
the momentum vectors $\bm{p}^{\vis}$ and $\bm{p}^{\inv}$.

%\begin{figure}[h]
%\begin{center}
%\includegraphics*[height=48mm]{figures/tauDecayParametrization.pdf}
%\end{center}
%\caption{
%
%}
%\label{fig:tauDecayParametrization}
%\end{figure} 

The parametrization of the $\Pgt$ decay kinematics by $\bm{p}^{\vis}$
and the variables $z$ and $\phi_{\inv}$ ($z$, $\phi_{\inv}$, and $m_{\inv}$) 
allows to simplify the evaluation of integral in Eq.~(\ref{eq:mem_with_hadRecoil}) by means of analytic transformations.
Expressions for the product of the differential phase space elements
$d\Phi^{(i)}_{\tauhnu}$  and $d\Phi^{(i)}_{\ellnunu}$ with the squared
modulus of the ME, $\vert \mathcal{M}^{(i)}_{\Pgt}(\bm{p}) \vert^{2}$, are derrived in Sections~\ref{sec:appendix_tauToHadDecays} and~\ref{sec:appendix_tauToLepDecays} of the appendix.
The results are:
\begin{align}
\vert \mathcal{M}^{(i)}_{\Pgt} \vert^{2} \, d\Phi^{(i)}_{\tauhnu} 
 = & \, \frac{\pi}{m_{\Pgt}\Gamma_{\Pgt}} \,
 f_{\Phadron}\left(\bm{p^{\vis(i)}}, m^{\vis(i)},
   \bm{p^{\inv(i)}}\right) \, \frac{d^{3}\bm{p^{\vis}}}{2 E_{\vis}} \, dz \, d\phi_{\inv} \nonumber \\
\vert \mathcal{M}^{(i)}_{\Pgt} \vert^{2} \, d\Phi^{(i)}_{\ellnunu} 
 = & \, \frac{\pi}{m_{\Pgt}\Gamma_{\Pgt}} \, f_{\ell}\left(\bm{p^{\vis(i)}},
 m^{\vis(i)}, \bm{p^{\inv(i)}}\right) \, \frac{d^{3}\bm{p^{\vis}}}{2 E_{\vis}} \, dz \, dm^{2}_{\inv} \, d\phi_{\inv}
 \, .
\label{eq:PSint}
\end{align}
The four-momentum vector $\bm{p^{\inv(i)}}$ is computed as function of
$\bm{p}^{\vis}$ and of the kinematic variables $z$ and $\phi_{\inv}$,
respectively $z$, $\phi_{\inv}$, and $m_{\inv}$.
The functions $f_{\Phadron}$ and $f_{\Plepton}$ are given by
Eqs.~(\ref{eq:hadTauDecays_f})
and~(\ref{eq:lepTauDecays_f})
for hadronic and leptonic $\Pgt$ decays, respectively.

Eq.~(\ref{eq:PSint}) represents the quintessence of what one needs to do
in order to extend the ME generated by automatized tools
\textsc{CompHEP} or \textsc{MadGraph}
by routines that handle the $\Pgt$ decays.
Instead of performing an integration over $d^{3}p^{\Pgt(1)} \,
d^{3}p^{\Pgt(2)}$ treating the $\Pgt$ leptons as stable particles,
one needs to perform the integration over $\vert
\mathcal{M}^{(1)}_{\Pgt} \vert^{2} \, d\Phi^{(1)} \, \vert
\mathcal{M}^{(2)}_{\Pgt} \vert^{2} \, d\Phi^{(2)}$, according to
Eq.~(\ref{eq:PSint}).
The four-vectors of both $\Pgt$ leptons need to be computed as
function of the integration variables $z^{(1)}$, $\phi_{\inv}^{(1)}$,
$m_{\inv}^{(1)}$ and $z^{(2)}$, $\phi_{\inv}^{(2)}$,
$m_{\inv}^{(2)}$, using Eqs.~(\ref{eq:E_inv}) and~(\ref{eq:theta_inv})
(with $m_{\inv}^{(i)}$ being equal to zero if the $i$-th $\Pgt$ lepton
decays hadronically).
The $\Pgt$ lepton four-vectors can then be used to evaluate the other
terms in Eq.~(\ref{eq:mem_with_hadRecoil}).
Note that the dimension of the integration depends on the $\Pgt$ decay
mode.
In case both $\Pgt$ leptons decay to hadrons, the dimension of the
integration is $4$, in case one $\Pgt$ lepton decays hadronically and
the other decays leptonically the dimension is $5$, and in case both
$\Pgt$ leptons decay into an electron or muon the dimension is $6$.
 
In order to improve the accuracy of the numerical integration,
we perform a further variable transformation, replacing $z^{(2)}$ by $t_{\PHiggs}$.
The transformation is executed in two stages. 
In the first step, we replace $z^{(2)}$ by $q_{\PHiggs}^{2}$, defined by:
\begin{equation}
q_{\PHiggs}^{2} = \frac{m^{2}_{\vis}}{z^{(1)} \, z^{(2)}} \, .
\label{eq:varTransform_z2_to_tHiggs_1}
\end{equation}
Following Eq.~(8) in Ref.~\cite{Alwall:2010cq}, we then parametrize $q_{\PHiggs}^{2}$ by:
\begin{equation}
q_{\PHiggs}^{2} = m_{\PHiggs}^{2} + m_{\PHiggs} \, \Gamma_{\PHiggs}
\tan t_{\PHiggs} \, .
\label{eq:varTransform_z2_to_tHiggs_2}
\end{equation}
The form of the variable transformation in Eqs.~(\ref{eq:varTransform_z2_to_tHiggs_1}) and~(\ref{eq:varTransform_z2_to_tHiggs_2}) 
is chosen such that the Jacobi factor of the transformation from
$z^{(2)}$ to $t_{\PHiggs}$ equals the inverse of the squared modulus
of the Breit-Wigner propagator of the $\PHiggs$ boson, $\vert \BW_{\PHiggs} \vert^{2}$, in Eq.~(\ref{eq:meHiggsBreitWigner}),
thereby improving the numerical precision of the integral evaluation
in Eq.~(\ref{eq:mem_with_hadRecoil}) by 
reducing the variance of the integrand.
The Jacobi factor is given by:
\begin{equation}
\vert \frac{\partial z^{(2)}}{\partial q_{\PHiggs}^{2}} \, \frac{\partial
  q_{\PHiggs}^{2}}{\partial t_{\PHiggs}} \vert =
\frac{m^{2}_{\vis}}{q_{\PHiggs}^{4} \, z^{(1)}} \, \frac{(q_{\PHiggs}^{2}
  - m_{\PHiggs}^{2})^{2} + m_{\PHiggs}^{2} \,
  \Gamma_{\PHiggs}^{2}}{m_{\PHiggs} \, \Gamma_{\PHiggs}} \, .
\label{eq:JacobiFactor_z2_to_tHiggs}  
\end{equation}
Compared to Ref.~\cite{Alwall:2010cq} we differ by a factor $\frac{1}{\pi}$ in the derivative 
$\frac{\partial q_{\PHiggs}^{2}}{\partial t_{\PHiggs}}$. We have verified that Eq.~(\ref{eq:JacobiFactor_z2_to_tHiggs}) is correct.

